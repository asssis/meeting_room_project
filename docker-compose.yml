version: "3.9"

services:
  #
  # 1) MIGRATOR — executa migrations e sai (não reinicia)
  #
  migrator:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: meeting_migrator:latest
    container_name: meeting_migrator
    working_dir: /app
    volumes:
      - ./backend/:/app:cached
      - ./backend/Data:/app/Data
    environment:
      ConnectionStrings__DefaultConnection: "Data Source=/app/Data/meeting.db"
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"
    command: >
      bash -lc "
        set -e;
        echo 'Instalando dotnet-ef (se necessário)...';
        dotnet tool install --global dotnet-ef --add-source https://api.nuget.org/v3/index.json || true;
        export PATH=\"/root/.dotnet/tools:$PATH\";
        echo 'Restaurando e construindo...';
        dotnet restore;
        dotnet build;
        echo 'Aplicando migrations...';
        dotnet ef database update --project . --verbose || (echo 'MIGRATION FAILED' && exit 1);
        echo 'Migrations aplicadas com sucesso.';
        sleep 1;
      "
    restart: "no"

  #
  # 2) API — imagem publicada a partir do Dockerfile em backend/
  #
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: meeting_api:latest
    container_name: meeting_api
    depends_on:
      - migrator
    ports:
      - "5000:80"    # acessar backend -> http://localhost:5000
    environment:
      ASPNETCORE_URLS: "http://+:80"
      ASPNETCORE_ENVIRONMENT: "Development"
      ConnectionStrings__DefaultConnection: "Data Source=/app/Data/meeting.db"
    volumes:
      - ./backend/Data:/app/Data
      - ./backend/docker-entrypoint.sh:/app/docker-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/app/docker-entrypoint.sh"]
    restart: unless-stopped

  #
  # 3) API-DEV — modo desenvolvimento (hot reload) (use só em dev)
  #
  api-dev:
    image: mcr.microsoft.com/dotnet/sdk:8.0
    container_name: meeting_api_dev
    working_dir: /app
    depends_on:
      - migrator
    ports:
      - "5001:80"    # backend dev -> http://localhost:5001
    environment:
      ASPNETCORE_URLS: "http://+:80"
      ASPNETCORE_ENVIRONMENT: "Development"
      ConnectionStrings__DefaultConnection: "Data Source=/app/Data/meeting.db"
    volumes:
      - ./backend/:/app:cached
      - ./backend/Data:/app/Data
    command: >
      bash -lc "
        echo 'Aguardando DB...';
        for i in {1..60}; do
          if [ -f /app/Data/meeting.db ]; then
            echo 'DB encontrado.';
            break;
          fi;
          echo 'Aguardando banco...'; sleep 1;
        done;
        dotnet restore;
        dotnet watch run --project ./MeetingRoom.Api.csproj --urls http://0.0.0.0:80
      "
    restart: on-failure

  #
  # 4) FRONTEND — build usando Dockerfile em frontend/ e Nginx em runtime
  #
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: meeting_frontend:latest
    container_name: meeting_frontend
    ports:
      - "3000:80"    # acessar frontend -> http://localhost:3000
    restart: unless-stopped
    environment:
      # interno: use o nome do serviço 'api' para falar com o backend dentro da rede do compose
      VITE_API_BASE_URL: "http://api"
    volumes:
      # monte apenas em dev se quiser editar código; em produção remova este volume
      # - ./frontend:/app:cached
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro

networks:
  default:
    name: meeting_project_network
